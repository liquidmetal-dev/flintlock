name: bump firecracker

on:
  workflow_dispatch: {}
  schedule:
  - cron: 0 0 * * 1

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        ssh-key: ${{ secrets.WEAVEWORKSBOT_TOKEN }}
        fetch-depth: 0
    - name: Bump firecracker
      run: |
        new_version=$(./hack/scripts/bump_firecracker.sh)
        if [[ "$new_version" == "" ]]; then
          echo "No new Firecracker release. Nothing to do. (this is not an error, no worries.)"
        fi

        echo 'NEW_VERSION<<EOF' >> $GITHUB_ENV
        echo "${new_version}" >> $GITHUB_ENV
        echo 'EOF' >> $GITHUB_ENV
    - name: Create PR
      if: ${{ env.NEW_VERSION != '' }}
      uses: peter-evans/create-pull-request@v3
      id: cpr
      with:
        commit-message: Bump firecracker version in e2e tests to ${{ env.NEW_VERSION }}
        committer: weaveworksbot <weaveworksbot@users.noreply.github.com>
        author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
        branch: bump-firecracker-${{ github.sha }}
        base: main
        delete-branch: true
        title: 'WIP chore(deps): bump firecracker version to ${{ env.NEW_VERSION }}'
        body: |
          This is an automatically generated PR to bump the version of firecracker
          in our tests. There are some manual steps to get new releases of our fork
          branch published.
          This PR is to track those manual steps.

          To complete work on this PR:
          - [ ] Update (merge or rebase) the [fork macvtap feature branch](https://github.com/weaveworks/firecracker/tree/feature/macvtap) to the latest upstream release tag ${{ env.NEW_VERSION }}. **Note: Do not update the feature branch to upstream main.**
          - [ ] Make sure it builds. (See: [doc](https://github.com/weaveworks/flintlock/blob/main/docs/quick-start.md#set-up-firecracker))
          - [ ] Push the updated firecracker 'feature/macvtap' fork branch.
          - [ ] Create a new tag on the updated firecracker 'feature/macvtap' fork branch: `git tag -s ${{ env.NEW_VERSION}}-macvtap -m ${{ env.NEW_VERSION }}-macvtap`.
          - [ ] Push the tag to the fork: `git push <remote> ${{ env.NEW_VERSION }}-macvtap` (A new [release](https://github.com/weaveworks/firecracker/releases) will be created.)
          - [ ] In this repo, trigger the `nightly_e2e` workflow to run on the `bump-firecracker-${{ github.sha }}` branch.
          - Once the tests have passed:
              - [ ] Edit the title of this PR to remove the 'WIP'
              - [ ] Mark this PR as ready to review
              - [ ] Approve and merge

          Auto-generated by [create-pull-request](https://github.com/peter-evans/create-pull-request).
        labels: |
          area/testing
          area/firecracker
          area/dependency
          kind/feature
        draft: true
  notify:
    needs: [update]
    if: ${{ failure() }}
    runs-on: ubuntu-latest
    steps:
    - name: Notify slack on failure
      uses: actions-ecosystem/action-slack-notifier@fc778468d09c43a6f4d1b8cccaca59766656996a
      with:
        slack_token: ${{ secrets.SLACK_TOKEN }}
        message: "Updating the firecracker version failed :sad-parrot: <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|Click here>."
        channel: team-quick-silver
        color: red
        verbose: false
